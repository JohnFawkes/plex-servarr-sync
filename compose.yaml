services:
  plex-servarr-sync:
#    image: ghcr.io/johnfawkes/plex-servarr-sync:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: plex-servarr-sync
    restart: unless-stopped
    env_file:
      - .env

    ports:
      - "${PORT:-5000}:${PORT:-5000}"

    environment:
      # ── Plex ──────────────────────────────────────────────────────────────
      PLEX_URL:     "${PLEX_URL:-http://192.168.1.100:32400}"
      PLEX_TOKEN:   "${PLEX_TOKEN}"
      PLEX_TIMEOUT: "${PLEX_TIMEOUT:-60}"
      # Stable identifier so Plex doesn't create a new device on every restart
      PLEXAPI_HEADER_IDENTIFIER: "${PLEXAPI_HEADER_IDENTIFIER:-plex-servarr-sync}"

      # ── Timezone ──────────────────────────────────────────────────────────
      # IANA timezone name — used for log timestamps and sync history display.
      # Examples: America/New_York, Europe/London, Australia/Sydney
      # Defaults to UTC if unset.
      TZ: "${TZ:-UTC}"

      # ── Rclone RC ──────────────────────────────────────────────────────────
      # Set USE_RCLONE=true only if you use an rclone VFS mount.
      # All RCLONE_* vars below are ignored when USE_RCLONE=false.
      USE_RCLONE:           "${USE_RCLONE:-false}"
      RCLONE_RC_URL:        "${RCLONE_RC_URL:-}"     # e.g. http://rclone:5572
      RCLONE_RC_USER:       "${RCLONE_RC_USER:-}"
      RCLONE_RC_PASS:       "${RCLONE_RC_PASS:-}"
      RCLONE_MOUNT_ROOT:    "${RCLONE_MOUNT_ROOT:-}" # e.g. /mnt/media

      # ── Timing ────────────────────────────────────────────────────────────
      WEBHOOK_DELAY: "${WEBHOOK_DELAY:-30}"  # wait after webhook before scanning (s/m/h)
      MINIMUM_AGE:   "${MINIMUM_AGE:-0}"     # minimum file age before scan (e.g. 60s)

      # ── Path mappings (JSON) ───────────────────────────────────────────────
      # Map paths as Sonarr/Radarr reports them → paths inside this container.
      # Example: '{ "/remote/tv": "/mnt/media/tv" }'
      PATH_REPLACEMENTS:        "${PATH_REPLACEMENTS:-{}}"
      # Only needed when USE_RCLONE=true. Maps paths to rclone host paths.
      RCLONE_PATH_REPLACEMENTS: "${RCLONE_PATH_REPLACEMENTS:-{}}"

      # Map path prefixes → Plex library section IDs.
      # Example: '{ "/mnt/media/tv": "1", "/mnt/media/movies": "2" }'
      SECTION_MAPPING: "${SECTION_MAPPING:-{}}"

      # ── Manual UI auth ────────────────────────────────────────────────────
      MANUAL_USER: "${MANUAL_USER:-admin}"
      MANUAL_PASS: "${MANUAL_PASS:-changeme}"
      # Secret key for signing session cookies. Set a long random string.
      # Generate one with: python3 -c "import secrets; print(secrets.token_hex(32))"
      SECRET_KEY:  "${SECRET_KEY}"

    # Mount the same media root that Plex uses so age-checks work.
    # Remove this volume if you don't use MINIMUM_AGE.
    volumes:
      - "${MEDIA_ROOT:-/mnt/media}:${MEDIA_ROOT:-/mnt/media}:ro,rslave"
      # Persistent storage for sync history database
      - plex-servarr-sync-data:/data

    healthcheck:
      test: /bin/sh -c 'curl -sf http://localhost:$${PORT:-5000}/health || exit 1'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  plex-servarr-sync-data:
